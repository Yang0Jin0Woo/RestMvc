<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>회원 목록</title>
    <style>
        .table { border-collapse: collapse; width: 100%; }
        .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .table thead th { background: #f7f7f7; }
        .pagination { margin-top: 16px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .pagination a, .pagination span { text-decoration: none; padding: 4px 8px; border-radius: 4px; }
        .pagination a { border: 1px solid #ddd; }
        .pagination .current-page { font-weight: 700; color: #d00; }
        .muted { color: #888; }
    </style>
</head>
<body>
<h1>회원 목록</h1>
<a th:href="@{/members/new}">+ 새 회원 등록</a>

<table class="table">
    <thead>
    <tr><th>ID</th><th>이름</th><th>이메일</th><th>설정</th></tr>
    </thead>
    <tbody id="member-tbody">
    <!-- 초기 SSR: page 0 내용 (JS 미동작/첫화면 깜빡임 방지) -->
    <tr th:each="m : ${memberPage.content}">
        <td th:text="${m.id}">1</td>
        <td th:text="${m.name}">홍길동</td>
        <td th:text="${m.email}">hong@example.com</td>
        <td>
            <a th:href="@{|/members/${m.id}|}">상세</a> |
            <a th:href="@{|/members/${m.id}/edit|}">수정</a> |
            <form th:action="@{|/members/${m.id}/delete|}" method="post" style="display:inline;">
                <button type="submit" onclick="return confirm('삭제하시겠습니까?');">삭제</button>
            </form>
        </td>
    </tr>
    </tbody>
</table>

<div class="pagination" th:if="${memberPage.totalPages > 1}">
    <span id="page-info"
          th:text="'페이지 ' + (${memberPage.number} + 1) + ' / ' + ${memberPage.totalPages}">
      페이지 정보
    </span>
    <div id="page-links"></div>
</div>

<script th:inline="javascript" defer>
    /*<![CDATA[*/
    const apiUrl = /*[[@{/api/members/page}]]*/ '/api/members/page';
    const basePath = /*[[@{/members}]]*/ '/members';
    const urlParams = new URLSearchParams(window.location.search);

    // URL은 1-based, API는 0-based
    let currentPage = urlParams.has('page')
      ? Math.max(0, parseInt(urlParams.get('page')) - 1)
      : /*[[${memberPage.number}]]*/ 0;

    const pageSize = urlParams.has('size')
      ? parseInt(urlParams.get('size'))
      : /*[[${memberPage.size}]]*/ 10;

    const PAGE_GROUP_SIZE = 10;

    function updateUrl(zeroBasedPage) {
      const oneBased = zeroBasedPage + 1;
      history.replaceState(null, '', `${basePath}?page=${oneBased}&size=${pageSize}`);
    }

    function renderRows(list) {
      const tbody = document.getElementById('member-tbody');
      tbody.innerHTML = '';
      const frag = document.createDocumentFragment();

      list.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.id}</td>
          <td>${m.name}</td>
          <td>${m.email}</td>
          <td>
            <a href="/members/${m.id}">상세</a> |
            <a href="/members/${m.id}/edit">수정</a> |
            <form action="/members/${m.id}/delete" method="post" style="display:inline;">
              <button type="submit" onclick="return confirm('삭제하시겠습니까?');">삭제</button>
            </form>
          </td>`;
        frag.appendChild(tr);
      });

      tbody.appendChild(frag);
    }

    function renderPagination(p) {
      document.getElementById('page-info').textContent =
        `페이지 ${p.number + 1} / ${p.totalPages}`;

      const container = document.getElementById('page-links');
      container.innerHTML = '';

      const currentOne = p.number + 1;
      const groupIdx = Math.floor((currentOne - 1) / PAGE_GROUP_SIZE);
      const start = groupIdx * PAGE_GROUP_SIZE + 1;
      const end = Math.min(start + PAGE_GROUP_SIZE - 1, p.totalPages);

      const addItem = (el) => container.appendChild(el);

      // 이전 그룹
      if (start > 1) {
        const prev = document.createElement('a');
        prev.href = '#';
        prev.textContent = '이전';
        prev.onclick = e => { e.preventDefault(); getMemberList(Math.max(0, start - PAGE_GROUP_SIZE - 1)); };
        addItem(prev);
      } else {
        const span = document.createElement('span'); span.className = 'muted'; span.textContent = '이전'; addItem(span);
      }

      // 번호들
      for (let i = start; i <= end; i++) {
        if (i === currentOne) {
          const s = document.createElement('span'); s.textContent = i; s.className = 'current-page'; addItem(s);
        } else {
          const a = document.createElement('a'); a.href = '#'; a.textContent = i;
          a.onclick = e => { e.preventDefault(); getMemberList(i - 1); };
          addItem(a);
        }
      }

      // 다음 그룹
      if (end < p.totalPages) {
        const next = document.createElement('a');
        next.href = '#';
        next.textContent = '다음';
        next.onclick = e => { e.preventDefault(); getMemberList(end); };
        addItem(next);
      } else {
        const span = document.createElement('span'); span.className = 'muted'; span.textContent = '다음'; addItem(span);
      }
    }

    function getMemberList(page = currentPage) {
      fetch(`${apiUrl}?page=${page}&size=${pageSize}`)
        .then(res => res.json())
        .then(p => {
          renderRows(p.content);
          currentPage = p.number;
          updateUrl(currentPage);
          renderPagination(p);
        });
    }

    document.addEventListener('DOMContentLoaded', () => { getMemberList(currentPage); });
    /*]]>*/
</script>
</body>
</html>
